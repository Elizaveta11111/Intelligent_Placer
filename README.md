## Постановка задачи
На вход алгоритму подается фотография на которой находится некоторое количество заранее известных и фиксированных предметов и лист А4 с изображением многоугольника, расположенных на светлой горизонтальной поверхности.

Так же алгоритм имеет доступ к фотографии поверхности на которой расположены предметы и лист с многоугольником.

Требования к предметам:
- предметы вместе с их тенями должны быть отделены друг от друга не менее чем 10 пикселями
- на фотографии не могут отсутствовать предметы
- на одной фотографии не может быть двух одинаковых предметов
- предметы расположены на фотографии целиком
- предметы не пересекаются с листом, на котором изображен многоугольник
- длинна теней не более 5% от размеров предмета

Требования к многоугольнику:
- многоугольник должен быть простым, число углов многоугольника не должно быть больше 10
- многоугольник должен быть нарисован темным маркером на белом листе
- не рисовать на листе что-то вместо или кроме многоугольника
- если предметы можно разместить в многоугольнике, то расстояние между предметами в этом размещении и от предметов до границ многоугольника должно быть больше 3 мм.
- лист с многоугольником целиком находиться на фотографии

Требования к поверхности:
- однотонная
- на ней должны хорошо выделяться предметы и границы листа бумаги
- на ней не должны присутсвовать посторонние предметы

Требования к входным фотографиям:
- высота съемки 30-50 см
- камера должна быть расположена перпендикулярно к поверхности и наклонена не более чем на 10 градусов
- отсутствие пересвеченных и серо-черных областей
- входные фотографии и фотография фона сделаны при одном и ом же освещении и с одинаковым разрешением
- цвета предметов на фото (отношения интенсивностей rgb каналов) не искажены   



Результат работы программы - True если предметы на фото можно разместить в заданном многоугольнике и False если нельзя.

## План решения задачи
### Распознование многоугольника
Выделим лист с многоугольником на изображении с помощью бинаризации. Кроме него на маске присутствуют только шумы, поэтому выделив две наибольшие компоненты связности можем отделить лист и многоугольник. Применим морфологичексие операции, чтобы избавиться от шумов и линии маркера на листе.  
Далее найдем вершины листа и многоугольника с помощью OpenCV.  
Теперь необходимо определить координаты многоугольника относительно листа. Для этого найдем афинное преобразование, которое преводит координаты нижнего левого угла листа на фото в естесственный масштаб. Угол на фото необходимо выбрать так, чтобы стороны угла образовывали правую тройку векторов с осью z. Определить ориентацию можно вычислив направление векторного произведения, при этом достаточно знать только последнюю компоненту так как оно определяет знак по оси z. В конце применим найденное преобразование к многоугольнику.
### Распознование предметов
1. Вычесть из изображения фон и убрать шум по порогу. 
2. Получить маску предметов и выделить компоненты связности с достаточно большой площадью.
3. Для каждой компоненты, определить минимальный ограничивающий прямоугольник.

Далее предметы идентифицируются из следующих соображений:
1. Для каждого предмета по маске можно найти минимальный ограничивающий его четырехугольник. Кроме того, известно координатное преобразование, переводящее лист на изображении в прямоугольник 210x297. Применив его к найденным четырехугольникам можем оценить ширину и высоту предмета.
2. Чтобы распознать предметы по цвету рассматривается отношение всех пикселей в маске к пикселям определенного цвета. Цвет пикселя определяется по отношению rgb компонент.
3. Ножницы не имеют какого-то выраженного цвета и схожи размерами с другими предметами. Их можно различить по отношению площади маски к площади четырехугольника, оно должно быть достаточно маленьким.
### Размещение предметов
Так как предметы заранее известны, запишем в коде программы коорднаты многоугольников, которыми можно их ограничить. После того как узнаем какие предметы находятся на фото и получим многоугольник будем решать задачу размещения этих ограничивающих предметы многоугольников.  
Так же заранее определим порядок размещения предметов - первыми будем пытаться разместить наибольшие по размерам. К тому же будем размещать предметы по краям многоугольника.  
Алгоритм размещения одного предмета:
1. Распологаем предмет так, чтобы одна из его вершин была в начале координат, а строна расположена на оси x.
2. Распологаем многоугольник таким же образом.
3. Если предмет лежит вне многоугольника, сдвигаем его вправо, пока он не окажется за ближайшей стороной.
4. Если предмет снова оказался вне многоугольника, то считаем что в данном случае предмет разместить нельзя.
5. Перебираем все варианты расположения предмета и многоугольника, в итоге получим список возможных размещений.

Далее для каждого полученного варианта получим новый многоугольник, убрав из старого занятую предметом часть, следущим образом:  
1. Выберем сторону многоугольника, на которой нет вершин предмета.
2. Идем по сторонам многоугольника, пока не встретим сторону на которой лежит вершина.
3. Будем двигаться из найденной точки по сторонам предмета пока снова не дойдем до точки которая лежит на многоугольнике. При этом у нас будет два варианта выбора направления обхода. Выберем то, для которого меньше угол между последней посещенной стороной многоугольника и следующей за ней стороной предмета.
5. Продолжим движение по сторонам многоугольника, сохранив направление обхода, пока не вернемся к исходной точке.
6. Все посещенные точки образуют искомый многоугольник. 
7. При различных начальных сторонах получим несколько таких многоугольников, поэтому выберем наибольший по площади.

Из полученных вариантов выбирается один так чтобы, он был достаточно близок к своей выпуклой оболочке, но при этом не имел бы слишком маленькую площадь.  
Описанная последовательность шагов применяется к полученному многоугольнику и следущему в списке предмету, пока не окажется что один из предметов не помещается, либо пока не кончатся предметы.

## Первая итерация
- Реализованно распознование многоугольников
- Реализованно распознование предметов с помощью особых точек, от которого пришлось отказаться из-за неэффективности 
- Реализован алгоритм только для одно из предметов.
## Вторая итерация
- Доработаны алгоритмы первой итерации
- Реализован описанный в плане алгоритм для распознавания объектов
- В алгоритме укладки реализован переход к новому многоугольнику, добавлена обработка всех предметов.
- Получены оценки результатов 

## Оценка результатов
#### Распознование многоугольника
Распознать многоугольник удалось для 36 фотографий из 37.  
#### Распознование предметов
Для собранных данных удается корректно распознать все предметы на всех фотографиях.
#### Упаковка предметов
Правильных ответов 30 из 37  
Процент правильных ответов: 81%

## Направления для улучшений
#### Распознование многоугольника
Координаты найденного на фотографии листа описывались прямоугольником. Не сложно заменить его на четырехугольник, тогда лучше будут учитываться перпективные искажения. Потенциально можно будет ослабить требования для входных фоторафий на наклон камеры.
#### Распознование предметов
Точность распознования обусловленна жесткими требованиями на входные фотографияи. Возможно получится ослабить требование на одинаковое освещение для фотографий если использовать бинаризацию вместо вычитания фона.  
Если получится учитывать перспективные искажения то можно будет точнее оценивать размеры предметов.  
Также можно улучшить существующий код, используя большее количество факторов при принятии решения о том какой объект выделен маской и усложнив соотношения при определения цвета.
#### Упаковка предметов
Основновной недостаток данной версии - низкая эффективность на невыпуклых многоугольниках.  
Другое направление улучшения - перебор результатов работы текущего алгоритма при разных порядках размещений предметов и при разных вариантах их расположения.  
В текущей версии при выборе нового многоугольника  рассматривается только наибольшая его часть, однако можно рассматривать все достаточно большие. Также есть другая проблема - не рассматримаются углы на обоих сторонах которого лежат вершины предметов.